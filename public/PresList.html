<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDIT MODE</title>
    <link href="./CSS/PresListCSS.css" rel="stylesheet">
</head>

<body>
    <p id="loggedInnId" class="loggedInnClass">Logged in as: USERNAME</p>
    <h1>Presentations:</h1>
    <div class="buttonDivClassDiv">
    <div id="buttonDiv" class="buttonDivClass">
        <button id="createNewPres">Create New Presentation</button>
        <button id="deletePres">Delete Presentations</button>
    </div>
    <div id="signOutButtonDiv" class="signOutButtonDivClass">
            <button id="signOut">Sign out</button>
    </div>
    </div>
    <div id="presList" class="presListDiv">
        <div style="width:auto; height: auto; background-color: gray; margin: 10px;"></div>
        <div>
                <h2>Pres title</h2>
                <p>info om presentasjon</p>
        </div>
        
    </div>

<div>
    <label for="share">share with username</label>
    <input id="share" type="text">
    <button id="sharebtn">share!</button>
    <button id="unsharebtn">unshare!</button>
</div>
</body>

<script>
    const shareinp = document.getElementById('share');
    const sharebtn = document.getElementById('sharebtn');
    const unsharebtn = document.getElementById('unsharebtn');
    const titleSlideTemp = `<h1 style="overflow:hidden;">Title</h1>`;
    const presentation = {
        id: undefined,
        title: "Ye Olde Presentatione",
        theme: "BW",
        slides: [titleSlideTemp]
    };


    /// ---------------------------------------------
    let welcome = document.getElementById("loggedInnId");
    let logout = document.getElementById('signOut');
    let newpres = document.getElementById('createNewPres');

    window.onload = init();

    async function init(){
        let username = localStorage.getItem("loggedin");
        let token = localStorage.getItem(`logintoken`);

        if(username && token) {
            welcome.innerHTML = `Logged in as ${username}`;
            loadPresentations(token);

            logout.addEventListener('click', endSession);
            newpres.addEventListener('click', startPres);
        }
        else {
            window.location.href = `index.html`;
        }
    }

    async function loadPresentations(token) {
        let userid = localStorage.getItem(`loggedID`);
        let url = `http://localhost:3000/presentations`;

        let updata = {
            userid: userid
        };
        let cfg = {
            method: "GET",
            headers: {"Content-Type":"application/json",
                "authorization": `${token}`,
                "userid" : `${userid}`},
        };
        let resp = await fetch(url, cfg);
        if(resp.ok){
            let presentations = await resp.json();
            console.log("Fetched it all!");
            console.log(presentations);
            console.log(presentations.allprts);
            console.log(JSON.parse(presentations.allprts[presentations.allprts.length-1].slide));
            for(let presentation of presentations.allprts) {
                let parsedpres = JSON.parse(presentation.slide);
                let presDiv = document.createElement('div');
                presDiv.innerHTML = parsedpres[0];
                presList.appendChild(presDiv);
            }
        }
    }


    async function endSession() {
        localStorage.clear();
        window.location.href = `index.html`;
    }

    function startPres() {
        window.location.href = `editMode.html`;
    }


    sharebtn.addEventListener('click', sharePresentationWith);
    unsharebtn.addEventListener('click', unsharePresentation);

    async function sharePresentationWith() {
        let token = localStorage.getItem(`logintoken`);
        let userid = localStorage.getItem(`loggedID`);

        const baseurl = `http://localhost:3000/presentations/share`;
        let recipient = shareinp.value;

        let updata = {
            title: presentation.title,
            theme: presentation.theme,
            slides: presentation.slides,
            userid: userid,
            recipient : recipient
        };
        let cfg = {
            method: "POST",
            headers: {"Content-Type":"application/json",
                "authorization": `${token}`},
            body: JSON.stringify(updata)
        };
        let resp = await fetch(`${baseurl}`, cfg);
        if(resp.ok) {
            alert("Presentation shared successfully.");
        }
        else {
            alert("We couldn't share your presentation.");
        }
    }

    async function unsharePresentation() {
        let url = `http://localhost:3000/presentations/unshare`;
        let token = localStorage.getItem(`logintoken`);
        let userid = localStorage.getItem(`loggedID`);

        let updata = {
            title : presentation.title,
            userid: userid
        };

        let cfg = {
            method: "DELETE",
            headers: {
                "Content-Type":"application/json",
                "authorization": `${token}`
            },
            body: JSON.stringify(updata)
        };
        let resp = await fetch(url,cfg);
        let data = await resp.json();
        console.log(data);
        if(resp.ok) {
            alert("Presentation unshared.");
        }
        else {
            alert("Presentation unsharing failed.");
        }
    }
</script>
</html>